<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>产品管理界面</title>
    <link rel="stylesheet" type="text/css" href="css/goodsManage.css">
    <link rel="stylesheet" type="text/css" href="css/iconfont.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/v4-shims.css">
</head>

<body>
    <div id="header">
        <ul>
            <li class="logo"><img src="./img/logo1.png" alt=""></li>
            <li>
                <h2>雅舍家具网站后台管理系统</h2>
            </li>
        </ul>
        <div class="log_out"><i class="fa fa-power-off "></i></div>
    </div>
    <div id="content">
        <div id="item">
            <div class="expand-btn">
                <div class="mini-btn">
                    <label>
                        <input type="checkbox" checked="checked">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="30" />
                            <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55" />
                            <path class="line--2" d="M0 50h80" />
                            <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45" />
                        </svg>
                    </label>
                </div>
            </div>
            <div class="left_menu">
                <div class="scroll">
                    <div class="menu">
                        <ul>
                            <li class="list">
                                <a href="javascript:;">
                                    <i class="my-icon lsm-sidebar-icon icon-users"></i><span>用户管理</span>
                                    <i class="my-icon lsm-sidebar-more"></i></a>
                                <ul>
                                    <li><a href="usersManage.html"><span>用户列表</span></a></li>
                                    <li><a href="javascript:;"><span>沙之国</span></a></li>
                                </ul>
                            </li>
                            <li class="list">
                                <a href="javascript:;"><i
                                        class="my-icon lsm-sidebar-icon icon_2"></i><span>商品管理</span><i
                                        class="my-icon lsm-sidebar-more"></i></a>
                                <ul>
                                    <li><a href="javascript:;"><span>商品列表</span></a></li>
                                    <li><a href="javascript:;"><span>分类列表</span></a></li>
                                    <li><a href="javascript:;"><span>八门遁甲1</span></a></li>
                                </ul>
                            </li>
                            <li class="list">
                                <a href="javascript:;"><i class="my-icon lsm-sidebar-icon icon-iconset0308"></i>
                                    <span>订单管理</span>
                                    <i class="my-icon lsm-sidebar-more"></i></a>
                                <ul>
                                    <li><a href="ordersManage.html"><span>订单列表</span></a></li>
                                    <li>
                                        <a href="javascript:;">
                                            <i class="my-icon lsm-sidebar-icon "></i><span>二级菜单11</span><i
                                                class="my-icon lsm-sidebar-more"></i></a>
                                        <ul>
                                            <li><a href="javascript:;"><span>地爆天星</span></a></li>
                                            <li><a href="javascript:;"><span>无线月读</span></a></li>
                                            <li><a href="javascript:;"><span>一乐拉面</span></a></li>
                                            <li><a href="javascript:;"><span>血继限界</span></a></li>
                                            <li><a href="javascript:;"><span>双蛇相杀</span></a></li>
                                        </ul>
                                    </li>
                                    <li><a href="javascript:;"><span>火影忍者</span></a></li>
                                </ul>
                            </li>
                            <li class="list">
                                <a href="javascript:;">
                                    <i class="my-icon lsm-sidebar-icon icon_1"></i><span>系统设置</span><i
                                        class="my-icon lsm-sidebar-more"></i>
                                </a>
                                <ul>
                                    <li><a href="javascript:;"><span>地爆天星</span></a></li>
                                    <li><a class="active" href="javascript:;"><span>无线月读</span></a></li>
                                    <li><a href="javascript:;"><span>一乐拉面</span></a></li>
                                    <li class="list">
                                        <a href="javascript:;">
                                            <i class="my-icon lsm-sidebar-icon "></i><span>二级菜单11</span><i
                                                class="my-icon lsm-sidebar-more"></i></a>
                                        <ul>
                                            <li><a href="javascript:;"><span>地爆天星</span></a></li>
                                            <li><a href="javascript:;"><span>无线月读</span></a></li>
                                            <li><a href="javascript:;"><span>一乐拉面</span></a></li>
                                            <li><a href="javascript:;"><span>血继限界</span></a></li>
                                            <li><a href="javascript:;"><span>双蛇相杀</span></a></li>
                                        </ul>
                                    </li>
                                    <li class="list">
                                        <a href="javascript:;">
                                            <i class="my-icon lsm-sidebar-icon "></i><span>二级菜单22</span><i
                                                class="my-icon lsm-sidebar-more"></i></a>
                                        <ul>
                                            <li><a href="javascript:;"><span>血继限界</span></a></li>
                                            <li><a href="javascript:;"><span>秽土转生</span></a></li>
                                            <li><a href="javascript:;"><span>万象天引</span></a></li>
                                            <li><a href="javascript:;"><span>尸鬼封尽</span></a></li>
                                            <li><a href="javascript:;"><span>飞雷神之术</span></a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
        <div id="msg">
            <nav>
                <ul>
                    <li><span>首页</span><i class="my-icon lsm-sidebar-more"></i></li>
                    <li><span>商品管理</span><i class="my-icon lsm-sidebar-more"></i></li>
                    <li><span><a>商品列表</a></span></li>
                </ul>
            </nav>
            <div id="info">
                <div id="search">
                    <div class="bar">
                        <select id="searchType">
                            <option value="goods_id"></option>
                        </select>
                        <input type="text" placeholder="请输入..." id="searchValue">
                        <i class="fa fa-search" id="searchBtn"></i>
                    </div>
                    <input type="button" value="添加产品" id="add">
                    <div class="bg"></div>
                    <div id="chart">
                        <h2>添加产品</h2>
                        <ul>
                            <li style="margin-top: 0;">
                                <label for="goods_name">商品名称</label>
                                <input id="goods_name" name="goods_name" type="text">
                            </li>
                            <li>
                                <label for="type">分类</label>
                                <input type="text" name="type" id="type">
                            </li>
                            <li>
                                <label for="price">价格</label>
                                <input id="price" name="price" type="text">
                            </li>
                            <li>
                                <label for="stock">库存</label>
                                <input type="text" name="stock" id="stock">
                            </li>
                            <li>
                                <label for="goods_id">商品编号：</label>
                                <input type="text" name="goods_id" id="goods_id">
                            </li>
                            <li>
                                <label for="upload" style="float: left;">上传图片：</label>
                                <input type="file" name="upload" id="upload">
                            </li>
                            <li class="image-box">
                                <!-- 展示图片预览 -->
                                <img id="pic" src="" alt="">
                            </li>
                            <p>
                                <button class="cancel">取消</button>
                                <button class="addGoods">确定</button>
                            </p>
                        </ul>
                    </div>
                    <div class="page">
                        <button id="firstPage">首页</button>
                        <button id="prePage">上一页</button>
                        <span><strong id="currentPage"></strong> / <strong id="pages"></strong> 页 </span>
                        <button id="nextPage">下一页</button>
                        <button id="lastPage">尾页</button>
                    </div>
                </div>
                <ul id="entry">
                    <div class="background"></div>
                    <div id="updateChart">
                        <h2>修改产品信息</h2>
                        <ul>
                            <li style="margin-top: 0;">
                                <label for="updateGoods_name">商品名称</label>
                                <input id="updateGoods_name" name="updateGoods_name" type="text">
                            </li>
                            <li>
                                <label for="updateType">分类</label>
                                <input type="updateText" name="updateType" id="type">
                            </li>
                            <li>
                                <label for="updatePrice">价格</label>
                                <input id="updatePrice" name="updatePrice" type="text">
                            </li>
                            <li>
                                <label for="updateStock">库存</label>
                                <input type="text" name="updateStock" id="updateStock">
                            </li>
                            <li>
                                <label for="updateGoods_id">商品编号：</label>
                                <input type="text" name="updateGoods_id" id="updateGoods_id">
                            </li>
                            <li>
                                <label for="upload" style="float: left;">修改图片：</label>
                                <input type="file" name="upload" id="upload">
                            </li>
                            <li class="image-box">
                                <!-- 展示图片预览 -->
                                <img id="updatePic" src="" alt="">
                            </li>
                            <p>
                                <button class="remove">取消</button>
                                <button class="updateGoods">确定</button>
                            </p>
                        </ul>
                    </div>
                </ul>

            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="javascripts/jquery.min.js"></script>
<script type="text/javascript" src="javascripts/jquery.slimscroll.min.js"></script>
<script type="text/javascript" src="javascripts/usersManage.js"></script>
<script>
    $(document).ready(function () {
        //data用来存放关于分页和搜索的相关数据
        let data = {
            searchType: 'goods_id',
            searchValue: '',
            currentPage: 1,
            pageSize: 4
        };
        getGoods();
        function getGoods() {
            $.ajax({
                url: '/manage/getGoods',
                data: {
                    currentPage: data.currentPage,
                    pageSize: data.pageSize,
                    searchType: data.searchType,
                    searchValue: data.searchValue
                },
                type: 'get',
                success({ message, status, goodsData }) {
                    // console.log(goodsData)
                    if (status) {
                        data = {
                            ...data,
                            ...goodsData
                        }
                        const str = goodsData.goodsData.map(function (item, index) {
                            return `
                        <li>
                            <div class="pic"><img src="./img/${item.pic}" alt=""></div>
                            <div class="goods_name">${item.goods_name}</div>
                            <ul>
                                <li class="type">分类：${item.type}</li>
                                <li class="price">价格：${item.price}</li>
                                <li class="stock">库存：${item.stock}</li>
                                <li class="goods_id">商品编号：${item.goods_id}</li>
                            </ul>
                            <div class="change">
                                <span style="margin-left: 15%;"><i class="fa fa-edit" id="updateBtn" data-id="${item._id}"></i></span><span style="color: rgb(161, 161, 161);">|</span>
                                <span><i class="fa fa-plus" id="increase" data-id="${item.goods_id}"></i></span><span style="color: rgb(161, 161, 161);">|</span>
                                <span><i class="fa fa-minus" id="reduce" data-id="${item.goods_id}"></i></span><span style="color: rgb(161, 161, 161);">|</span>
                                <span><i class="fa fa-trash" id="deleteBtn" data-id="${item._id}"></i></span>
                            </div>
                        </li>
                `;
                        }).join('');
                        $('#entry').html(str);

                        $('#currentPage').text(data.currentPage);
                        $('#pages').text(data.pages);
                    }
                }
            })
        }

        //分页列表
        $('#firstPage').click(function () {
            data.currentPage = 1;
            getGoods();
        })
        $('#nextPage').click(function () {
            if (data.currentPage < data.pages) {
                data.currentPage++;
                getGoods();
            }
        })
        $('#prePage').click(function () {
            if (data.currentPage > 1) {
                data.currentPage--;
                getGoods();
            }
        })
        $('#lastPage').click(function () {
            data.currentPage = data.pages;
            getGoods();
        })

        $('#add').click(function () {
            $('.bg').css({ 'display': 'block' });
            center($('#chart'));
            // check($(this).parent(), $('.addGoods'), $('.cancel'));
        });

        // 居中 
        function center(obj) {
            var screenWidth = $(window).width(), screenHeight = $(window).height(); //当前浏览器窗口的 宽高 
            var scrolltop = $(document).scrollTop();//获取当前窗口距离页面顶部高度 
            var objLeft = (screenWidth - obj.width()) / 2;
            var objTop = (screenHeight - obj.height()) / 2 + scrolltop;
            obj.css({ left: objLeft + 'px', top: objTop + 'px', 'display': 'block' });
            //浏览器窗口大小改变时 
            $(window).resize(function () {
                screenWidth = $(window).width();
                screenHeight = $(window).height();
                scrolltop = $(document).scrollTop();
                objLeft = (screenWidth - obj.width()) / 2;
                objTop = (screenHeight - obj.height()) / 2 + scrolltop;
                obj.css({ left: objLeft + 'px', top: objTop + 'px', 'display': 'block' });
            });
            //浏览器有滚动条时的操作、 
            $(window).scroll(function () {
                screenWidth = $(window).width();
                screenHeight = $(widow).height();
                scrolltop = $(document).scrollTop();
                objLeft = (screenWidth - obj.width()) / 2;
                objTop = (screenHeight - obj.height()) / 2 + scrolltop;
                obj.css({ left: objLeft + 'px', top: objTop + 'px', 'display': 'block' });
            });
        }
        //确定的操作 
        // function check(obj, obj1, obj2) {
        //     obj1.click(function () {
        //         closed($('.bg'), $('#chart'));
        //     });
        // }
        // 取消的操作 
        // function closed(obj1, obj2) {
        $('.cancel').click(function () {
            $('.bg').css({ 'display': 'none' })
            $('#chart').css({ 'display': 'none' })
        })
        $('.remove').click(function () {
            $('.background').css({ 'display': 'none' })
            $('#updateChart').css({ 'display': 'none' })
        })
        // }

        //新增商品
        $('.addGoods').click(function () {
            const goods_name = $('#goods_name').val();
            const type = $('#type').val();
            const price = $('#price').val();
            const stock = $('#stock').val();
            const goods_id = $('#goods_id').val();
            const pic = $('#pic').data('src');
            $.ajax({
                type: 'post',
                url: '/manage/addGoods',
                data: {
                    goods_name,
                    type,
                    price,
                    stock,
                    goods_id,
                    pic
                },
                success(msg) {
                    if (msg.status) {
                        getGoods();
                    }
                }
            })
        })

        //图片上传
        $('#upload').change(function () {
            // 1. 获取选中图片的相关信息
            const files = this.files;
            // 2. 将获取的图片信息添加到表单对象FormData中
            const formData = new FormData();
            formData.append('file', files[0]);
            // 3. 通过ajax将表单对象发送到后端服务器
            $.ajax({
                url: '/manage/upload',
                type: 'post',
                data: formData,
                // 不读取缓存中的结果
                cache: false,
                // 数据编码格式不适用juery的方式
                contentType: false,
                // 发送的图片数据不需要转换为其他格式
                processData: false,
                success(msg) {
                    console.log(msg)
                    if (msg.status) {
                        $('#pic')
                            .attr('src', `./img/${msg.data}`)
                            .data('src', msg.data)
                    }
                }
            })
        })

        //删除产品
        $('#entry').on('click', '#deleteBtn', function () {
            const _id = $(this).data('id');
            console.log(_id)
            const conf = confirm('您确定要删除此产品吗？');
            if (!conf) {
                return;
            }
            $.ajax({
                type: 'post',
                url: '/manage/deleteGoods',
                data: { _id },
                success(msg) {
                    if (msg.status) {
                        alert('删除成功!');
                        if (data.goodsData.length == 1) {
                            data.currentPage--;
                        }
                        getGoods();
                    } else {
                        return
                    }
                }
            })
        })

        //修改产品信息
        $('#entry').on('click', '#updateBtn', function () {
            console.log('aa')
            const _id = $(this).data('id');
            $('.background').css({ 'display': 'block' });
            center($('#updateChart'));
            // check($(this).parent(), $('.updateGoods'), $('.remove'));
            //获取要修改的用户信息
            $.ajax({
                type: 'get',
                url: '/manage/getUpdateGoods',
                data: { _id },
                success(msg) {
                    if (msg.status) {
                        $('#updateGoods_name').val(msg.getUpdateData.goods_name);
                        $('#updateType').val(msg.getUpdateData.type);
                        $('#updatePrice').val(msg.getUpdateData.price);
                        $('#updateStock').val(msg.getUpdateData.stock);
                        $('#updateGoods_id').val(msg.getUpdateData.goods_id);
                        $('#updatePic').val(msg.getUpdateData.pic);
                        getGoods();
                    }
                    console.log(msg);
                }
            })
        })

        //确认修改
        $('.updateGoods').click(function () {
            alert('修改成功！')
            $('.background').css({ 'display': 'none' })
            $('#updateChart').css({ 'display': 'none' })
            const _id = $('#updateId').val();
            const username = $('#updateUsername').val();
            const email = $('#updateEmail').val();
            const birthday = $('#updateBirthday').val();
            const address = $('#updateAddress').val();
            const phone = $('#updatePhone').val();
            $.ajax({
                url: '/manage/updateGoods',
                data: { _id, username, gender, email, birthday, address, phone },
                type: 'post',
                success(msg) {
                    console.log(msg)
                }
            })
        })

        //查询
        $('#searchBtn').click(function () {
            const searchType = $('#searchType').val()
            const searchValue = $('#searchValue').val();
            data = {
                ...data,//保留data原本的数据
                currentPage: 1,
                searchType,
                searchValue
            }
            getGoods();
        })

        //添加数量（事件委托）
        $("#entry").on('click', '#increase', function () {
            const goods_id = $(this).data('id');
            // console.log(goods_id)
            $.ajax({
                url: '/manage/addStock',
                data: { goods_id },
                type: 'post',
                success(msg) {
                    if (msg.status) {
                        console.log(msg);
                        getGoods();
                    }
                }
            })
        })

        //减少数量
        $("#entry").on('click', '#reduce', function () {
            const goods_id = $(this).data('id');
            $.ajax({
                url: '/manage/reduceStock',
                data: { goods_id },
                type: 'post',
                success(msg) {
                    if (msg.status) {
                        console.log(msg)
                        getGoods();
                    }

                }
            })
        })

        $('.log_out i').click(function () {
            location.href = 'index.html';

        })
    });
</script>

</html>